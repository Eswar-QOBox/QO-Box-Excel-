<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Excel Comparison Tool</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --primary: #2563eb;
      --primary-dark: #1d4ed8;
      --primary-light: #eff6ff;
      --card-bg: #ffffff;
      --card-shadow: 0 1px 3px rgba(0,0,0,.06);
      --card-shadow-hover: 0 4px 12px rgba(0,0,0,.08);
      --border: #e2e8f0;
      --text: #1e293b;
      --text-muted: #64748b;
      --tab-inactive: #f1f5f9;
      --added: #22c55e;
      --removed: #ef4444;
      --modified: #eab308;
      --radius: 12px;
      --radius-sm: 8px;
    }
    * { box-sizing: border-box; }
    body {
      font-family: "Segoe UI", system-ui, -apple-system, sans-serif;
      background: #f1f5f9;
      color: var(--text);
      margin: 0;
      min-height: 100vh;
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
    }
    button:focus-visible, .tab:focus-visible, .drop-zone:focus-visible, input:focus-visible, select:focus-visible {
      outline: 2px solid var(--primary);
      outline-offset: 2px;
    }

    /* Header */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem 1.5rem;
      background: var(--card-bg);
      border-bottom: 1px solid var(--border);
      box-shadow: var(--card-shadow);
    }
    .header-left {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    .header-logo {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      object-fit: contain;
      background: #fff;
      border: 1px solid var(--border);
      padding: 6px;
      display: inline-block;
    }
    .header-icon {
      width: 44px;
      height: 44px;
      background: var(--primary);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 1.25rem;
    }
    .header-title { font-size: 1.25rem; font-weight: 700; margin: 0; color: var(--text); }
    .header-subtitle { font-size: 0.8125rem; color: var(--text-muted); margin: 0.25rem 0 0 0; }
    .header-right {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    .brand-text { text-align: right; }
    .brand-name { font-size: 1.125rem; font-weight: 700; color: #d32f2f; margin: 0; }
    .brand-powered { font-size: 0.6875rem; color: var(--text-muted); margin: 0; letter-spacing: 0.02em; }
    .brand-powered .brand-powered-caps { text-transform: uppercase; }
    .brand-powered .brand-powered-normal { text-transform: none; }
    .brand-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--primary);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 0.875rem;
    }

    /* Excel Comparison & Results / Report tabs */
    .tabs {
      display: flex;
      gap: 0;
      padding: 5px;
      margin: 1rem 1.5rem;
      max-width: 520px;
      background: #e2e8f0;
      border-radius: var(--radius);
      box-shadow: inset 0 1px 2px rgba(0,0,0,.06);
    }
    .tab {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      background: transparent;
      color: var(--text-muted);
      border: none;
      font-size: 0.8125rem;
      font-weight: 600;
      cursor: pointer;
      border-radius: 8px;
      transition: background .2s, color .2s, box-shadow .2s;
    }
    .tab i { font-size: 0.875rem; }
    .tab.active {
      background: var(--primary);
      color: white;
      box-shadow: 0 1px 3px rgba(0,0,0,.12);
    }
    .tab:not(.active):hover { background: #e2e8f0; color: var(--text); }

    .main { padding: 1.5rem 1.25rem; max-width: 960px; margin: 0 auto; }

    .card {
      background: var(--card-bg);
      border-radius: var(--radius);
      box-shadow: var(--card-shadow);
      border: 1px solid var(--border);
      margin-bottom: 1.25rem;
      overflow: hidden;
      transition: box-shadow .2s;
    }
    .card:hover { box-shadow: var(--card-shadow-hover); }
    .card-head {
      padding: 1.25rem 1.5rem;
      border-bottom: 1px solid var(--border);
    }
    .card-title { font-size: 1.125rem; font-weight: 700; margin: 0; color: var(--text); }
    .card-subtitle { font-size: 0.875rem; color: var(--text-muted); margin: 0.35rem 0 0 0; }

    /* Upload areas */
    .upload-row { display: flex; gap: 1.5rem; padding: 1.5rem; flex-wrap: wrap; }
    .upload-col { flex: 1; min-width: 260px; }
    .upload-label { font-size: 0.9375rem; font-weight: 600; margin: 0 0 0.25rem 0; display: block; }
    .upload-desc { font-size: 0.8125rem; color: var(--text-muted); margin: 0 0 0.75rem 0; }
    .drop-zone {
      border: 2px dashed var(--border);
      border-radius: 10px;
      padding: 2rem;
      text-align: center;
      cursor: pointer;
      transition: border-color .2s, background .2s;
      background: #fafafa;
    }
    .drop-zone:hover, .drop-zone.dragover { border-color: var(--primary); background: var(--primary-light); }
    .drop-zone.has-file { border-color: var(--primary); background: #eff6ff; }
    .drop-zone .icon { color: var(--primary); font-size: 2.5rem; margin-bottom: 0.5rem; }
    .drop-zone .main-text { font-size: 0.9375rem; font-weight: 500; color: var(--text); display: block; }
    .drop-zone .sub-text { font-size: 0.8125rem; color: var(--text-muted); margin-top: 0.25rem; }
    .drop-zone input[type="file"] { display: none; }
    .file-name { font-size: 0.8125rem; color: var(--primary); margin-top: 0.5rem; font-weight: 500; }

    /* Uploaded file card (after uploading) */
    .file-card {
      display: none;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 1rem 1.25rem;
      background: var(--card-bg);
      align-items: flex-start;
      gap: 0.75rem;
    }
    .file-card.visible { display: flex; }
    .file-card-check {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--added);
      color: white;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.875rem;
    }
    .file-card-body { flex: 1; min-width: 0; }
    .file-card-name { font-size: 0.9375rem; font-weight: 600; color: var(--text); margin: 0 0 0.25rem 0; word-break: break-all; }
    .file-card-meta { font-size: 0.8125rem; color: var(--text-muted); margin: 0; }
    .file-card-remove {
      flex-shrink: 0;
      width: 28px;
      height: 28px;
      border: none;
      background: transparent;
      color: var(--text-muted);
      cursor: pointer;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
    }
    .file-card-remove:hover { background: #f1f5f9; color: var(--removed); }
    .upload-col .drop-zone.hidden { display: none; }

    /* Data preview below upload */
    .preview-row { display: flex; gap: 1.5rem; padding: 1rem 1.5rem; flex-wrap: wrap; }
    .preview-col { flex: 1; min-width: 280px; }
    .preview-col-title { font-size: 0.875rem; font-weight: 600; margin: 0 0 0.5rem 0; color: var(--text); }
    .preview-sheet-row { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; }
    .preview-sheet-label { font-size: 0.8125rem; color: var(--text-muted); }
    .preview-sheet-select { padding: 0.35rem 0.5rem; border: 1px solid var(--border); border-radius: 6px; font-size: 0.8125rem; min-width: 120px; }
    .sheet-option-group .sheet-select { width: auto; min-width: 140px; margin-left: 0.25rem; }
    .sheet-select-single { width: 100%; max-width: 320px; padding: 0.5rem 0.75rem; border: 1px solid var(--border); border-radius: 8px; font-size: 0.9375rem; background: var(--card-bg); }
    #keyInput.sheet-select-single { max-width: 280px; }
    .preview-placeholder { font-size: 0.875rem; color: var(--text-muted); padding: 1rem; background: #f8fafc; border-radius: 8px; min-height: 60px; }
    .preview-table-wrap { overflow-x: auto; max-height: 280px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px; }
    .preview-table-wrap table { width: 100%; border-collapse: collapse; font-size: 0.8125rem; }
    .preview-table-wrap th, .preview-table-wrap td { padding: 0.4rem 0.6rem; text-align: left; border-bottom: 1px solid var(--border); white-space: nowrap; }
    .preview-table-wrap th { background: #f1f5f9; color: var(--text-muted); font-weight: 500; position: sticky; top: 0; }
    .preview-table-wrap tr:last-child td { border-bottom: none; }
    .preview-meta { font-size: 0.75rem; color: var(--text-muted); margin-top: 0.35rem; }

    /* Comparison options */
    .options-inner { padding: 1.25rem 1.5rem; }
    .option-group { margin-bottom: 1.25rem; }
    .option-group:last-child { margin-bottom: 0; }
    .option-group-label { font-size: 0.875rem; font-weight: 600; margin-bottom: 0.5rem; display: block; color: var(--text); }
    .option-row { display: flex; align-items: center; gap: 1rem; flex-wrap: wrap; }
    .option-item { display: inline-flex; align-items: center; gap: 0.5rem; font-size: 0.9375rem; cursor: pointer; }
    .option-item input { margin: 0; cursor: pointer; }
    .key-input {
      margin-left: 0.5rem;
      padding: 0.4rem 0.6rem;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 0.875rem;
      width: 140px;
    }
    .key-input:disabled { background: #f1f5f9; color: var(--text-muted); }

    .mode-cards { display: flex; gap: 1rem; flex-wrap: wrap; margin-bottom: 1rem; }
    .mode-card {
      flex: 1;
      min-width: 220px;
      border: 2px solid var(--border);
      border-radius: 10px;
      padding: 1rem 1.25rem;
      cursor: pointer;
      transition: border-color .2s, background .2s;
      background: var(--card-bg);
    }
    .mode-card:hover { border-color: #cbd5e1; background: #f8fafc; }
    .mode-card.selected { border-color: var(--primary); background: #eff6ff; }
    .mode-card input { display: none; }
    .mode-card-icon { font-size: 1.5rem; color: var(--primary); margin-bottom: 0.5rem; }
    .mode-card-title { font-size: 0.9375rem; font-weight: 600; margin: 0 0 0.25rem 0; color: var(--text); }
    .mode-card-desc { font-size: 0.8125rem; color: var(--text-muted); margin: 0; line-height: 1.4; }

    .main-footer { text-align: center; font-size: 0.8125rem; color: var(--text-muted); padding: 2rem 1rem; margin-top: 0.5rem; }
    .compare-footer { display: flex; justify-content: flex-end; margin-top: 1.25rem; }
    .btn-compare {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      background: var(--primary);
      color: white;
      border: none;
      padding: 0.6rem 1.35rem;
      border-radius: 8px;
      font-size: 0.9375rem;
      font-weight: 600;
      cursor: pointer;
    }
    .btn-compare:hover { background: var(--primary-dark); transform: translateY(-1px); }
    .btn-compare:active { transform: translateY(0); }
    .btn-compare:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
    .btn-compare.loading { pointer-events: none; }
    .btn-compare .btn-spinner { display: none; width: 1em; height: 1em; border: 2px solid rgba(255,255,255,0.3); border-top-color: #fff; border-radius: 50%; animation: btn-spin 0.7s linear infinite; }
    .btn-compare.loading .btn-spinner { display: inline-block; }
    .btn-compare.loading .fa-play { display: none; }
    @keyframes btn-spin { to { transform: rotate(360deg); } }

    /* Results tab content */
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    .results-empty {
      text-align: center;
      padding: 3rem 2rem;
      background: var(--card-bg);
      border: 1px dashed var(--border);
      border-radius: 12px;
      color: var(--text-muted);
    }
    .results-empty i { font-size: 2.5rem; color: var(--primary); opacity: 0.5; margin-bottom: 0.75rem; display: block; }
    .results-empty p { margin: 0; font-size: 0.9375rem; line-height: 1.5; }
    .results-summary-wrap { background: #eff3f7; border-radius: 14px; padding: 1.25rem; margin-bottom: 1.5rem; }
    .results-summary { display: flex; gap: 1rem; flex-wrap: wrap; margin-bottom: 0; }
    .results-summary .card {
      margin-bottom: 0;
      flex: 1;
      min-width: 100px;
      padding: 1rem 1.25rem;
      background: #fff;
      border: none;
      border-radius: 14px;
      box-shadow: 0 2px 8px rgba(0,0,0,.06), 0 1px 2px rgba(0,0,0,.04);
      border-left: 6px solid;
    }
    .results-summary .card.added { border-left-color: var(--added); }
    .results-summary .card.removed { border-left-color: var(--removed); }
    .results-summary .card.modified { border-left-color: var(--modified); }
    .enable-export-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      padding: 1rem 0;
      margin-bottom: 0.5rem;
      border-top: 1px solid var(--border);
    }
    .enable-export-label {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.9375rem;
      font-weight: 500;
      color: var(--text);
    }
    .enable-export-label i { color: var(--primary); }
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 44px;
      height: 24px;
      flex-shrink: 0;
    }
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: #cbd5e1;
      border-radius: 24px;
      transition: background 0.2s;
    }
    .toggle-slider::before {
      content: "";
      position: absolute;
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background: white;
      border-radius: 50%;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
      transition: transform 0.2s;
    }
    .toggle-switch input:checked + .toggle-slider { background: var(--primary); }
    .toggle-switch input:checked + .toggle-slider::before { transform: translateX(20px); }
    .toggle-switch input:focus-visible + .toggle-slider { box-shadow: 0 0 0 2px var(--primary); }
    .historic-data-section { margin-top: 0; }
    .historic-data-body { padding: 1.5rem; }
    .historic-data-placeholder { margin: 0; font-size: 0.9375rem; color: var(--text-muted); font-style: italic; }
    .results-header { display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between; gap: 1rem; margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border); }
    .results-meta { display: flex; flex-wrap: wrap; align-items: center; gap: 1rem; font-size: 0.875rem; color: var(--text-muted); }
    .results-meta-item i { margin-right: 0.35rem; color: var(--primary); }
    .results-status { display: inline-flex; align-items: center; gap: 0.35rem; padding: 0.35rem 0.75rem; background: #dcfce7; color: #166534; border-radius: 999px; font-size: 0.8125rem; font-weight: 600; }
    .results-status .status-dot { font-size: 0.5rem; color: #22c55e; }
    .results-export { display: flex; gap: 0.5rem; }
    .btn-export { display: inline-flex; align-items: center; gap: 0.4rem; padding: 0.4rem 0.75rem; border: 1px solid var(--border); border-radius: 6px; background: var(--card-bg); font-size: 0.8125rem; cursor: pointer; color: var(--text); }
    .btn-export:hover { background: #f1f5f9; }
    .results-validation-tabs { display: flex; gap: 0.25rem; margin-bottom: 1rem; }
    .validation-tab { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; border: none; background: var(--tab-inactive); color: var(--text-muted); border-radius: 8px; font-size: 0.875rem; font-weight: 500; cursor: pointer; }
    .validation-tab:hover { background: #e2e8f0; color: var(--text); }
    .validation-tab.active { background: var(--primary); color: white; }
    .validation-content { display: none; }
    .validation-content.active { display: block; }
    .sheet-count-summary { background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; padding: 1.25rem; }
    .sheet-count-summary-title { margin: 0 0 1rem 0; font-size: 1rem; font-weight: 600; color: var(--text); display: flex; align-items: center; gap: 0.5rem; }
    .sheet-count-summary-title i { color: var(--primary); }
    .sheet-count-cards { display: flex; gap: 1rem; flex-wrap: wrap; }
    .sc-card { flex: 1; min-width: 120px; padding: 1rem; background: #f8fafc; border: 1px solid var(--border); border-radius: 10px; }
    .sc-card-label { display: block; font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.35rem; }
    .sc-card-value { font-size: 1.5rem; font-weight: 700; color: var(--text); }
    .sc-card-diff .sc-card-value { background: #fff7ed; color: #c2410c; padding: 0.15rem 0.5rem; border-radius: 6px; }
    .sc-card-diff.match .sc-card-value { background: #dcfce7; color: #166534; }

    .sheet-presence-analysis { margin-top: 1.25rem; }
    .sheet-presence-title { margin: 0 0 1rem 0; padding: 0; font-size: 1rem; font-weight: 600; color: var(--text); display: flex; align-items: center; gap: 0.5rem; }
    .sheet-presence-title i { color: #f59e0b; }
    .presence-section { padding: 1.25rem; border-radius: 1rem; margin-bottom: 1rem; border: 1px solid; }
    .presence-section:last-child { margin-bottom: 0; }
    .presence-heading-row { display: flex; align-items: flex-start; justify-content: space-between; gap: 0.75rem; margin-bottom: 0.75rem; }
    .presence-heading { margin: 0; font-size: 1.125rem; font-weight: 600; display: flex; align-items: center; gap: 0.5rem; }
    .presence-count { padding: 0.25rem 0.625rem; border-radius: 999px; font-size: 0.75rem; font-weight: 700; }
    .presence-desc { margin: 0 0 0.75rem 0; font-size: 0.875rem; }
    .presence-tags { display: flex; flex-wrap: wrap; gap: 0.5rem; }
    .presence-tag { display: inline-block; padding: 0.375rem 1rem; border-radius: 0.75rem; font-size: 0.875rem; font-weight: 500; }
    /* Matched Sheets – from reference: emerald card, count pill, white/gray tags */
    .presence-matched { background: #ecfdf5; border-color: #a7f3d0; }
    .presence-matched .presence-heading { color: #065f46; }
    .presence-matched .presence-count { background: #d1fae5; color: #047857; }
    .presence-matched .presence-desc { color: #047857; }
    .presence-matched .presence-tag { background: #fff; color: #1f2937; border: 1px solid #f3f4f6; box-shadow: 0 1px 2px rgba(0,0,0,.05); }
    .presence-matched .presence-tag:empty { display: none; }
    .presence-missing .presence-count { background: #fecaca; color: #991b1b; }
    .presence-missing { background: #fff1f2; border-color: #fecaca; }
    .presence-missing .presence-heading { color: #991b1b; }
    .presence-missing .presence-desc { color: rgba(185,28,28,.8); }
    .presence-missing .presence-tag { background: #dc2626; color: #fff; font-weight: 700; box-shadow: 0 4px 6px -1px rgba(220,38,38,.2); }
    .presence-additional .presence-count { background: #bae6fd; color: #0369a1; }
    .presence-additional { background: #f0f9ff; border-color: #7dd3fc; }
    .presence-additional .presence-heading { color: #0c4a6e; }
    .presence-additional .presence-desc { color: rgba(2,132,199,.8); }
    .presence-additional .presence-tag { background: #fff; color: #0284c7; border: 1px solid #bae6fd; font-weight: 700; box-shadow: 0 1px 2px rgba(0,0,0,.05); }
    .cell-level-results { background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; padding: 1.25rem; margin-bottom: 1rem; }
    .cell-level-header-row { display: flex; flex-wrap: wrap; align-items: flex-start; justify-content: space-between; gap: 1rem; margin-bottom: 0.5rem; }
    .cell-level-header-row .cell-level-title { margin-bottom: 0.25rem; }
    .cell-level-export-btns { display: flex; gap: 0.5rem; flex-shrink: 0; }
    .cell-level-title { margin: 0 0 0.25rem 0; font-size: 1.25rem; font-weight: 700; color: var(--text); }
    .cell-level-subtitle { margin: 0 0 1rem 0; font-size: 0.875rem; color: var(--text-muted); }
    .cell-level-sheet-select { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem; flex-wrap: wrap; }
    .cell-level-sheet-select .option-group-label { margin-bottom: 0; display: inline-flex; align-items: center; gap: 0.4rem; font-size: 0.875rem; font-weight: 600; color: var(--text); }
    .cell-level-sheet-select .option-group-label i { color: var(--primary); }
    .cell-level-sheet-tabs { display: flex; flex-wrap: wrap; gap: 0.5rem; flex: 1; min-width: 0; }
    .cell-level-sheet-badge { padding: 0.25rem 0.6rem; border-radius: 999px; font-size: 0.75rem; font-weight: 600; color: var(--text-muted); background: var(--card-bg); border: 1px solid var(--border); margin-left: auto; flex-shrink: 0; }
    .cell-level-sheet-tab { display: inline-flex; align-items: center; gap: 0.4rem; padding: 0.5rem 0.75rem; border: none; border-radius: 8px; background: var(--card-bg); color: var(--text); font-size: 0.8125rem; font-weight: 600; cursor: default; box-shadow: 0 1px 2px rgba(0,0,0,.06); }
    .cell-level-sheet-tab i { color: var(--primary); font-size: 0.875rem; }
    .cell-level-sheet-tab.active { background: var(--primary); color: white; box-shadow: none; }
    .cell-level-sheet-tab.active i { color: white; }
    .cell-level-sheet-tab .sheet-tab-count { margin-left: 0.15rem; padding: 0.2rem 0.5rem; min-width: 1.25rem; text-align: center; border-radius: 999px; font-size: 0.75rem; font-weight: 600; background: #fef9c3; color: #a16207; }
    .cell-level-sheet-tab.active .sheet-tab-count { background: rgba(255,255,255,.35); color: white; }
    .cell-level-sheet-tab.sheet-ok .sheet-tab-count { padding: 0; min-width: 0; background: transparent; color: inherit; }
    .cell-level-sheet-tab.sheet-ok .sheet-tab-count i { color: var(--added); }
    .cell-level-sheet-tab.active.sheet-ok .sheet-tab-count i { color: white; }
    .cell-level-tabs { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 1rem; }
    .cell-tab { display: inline-flex; align-items: center; gap: 0.4rem; padding: 0.5rem 0.75rem; border: 1px solid var(--border); border-radius: 8px; background: var(--card-bg); color: var(--text-muted); font-size: 0.8125rem; font-weight: 600; cursor: pointer; }
    .cell-tab:hover { background: #f8fafc; color: var(--text); }
    .cell-tab.active { background: #fef3c7; border-color: #f59e0b; color: #92400e; }
    .cell-tab.active .cell-tab-count { background: #fcd34d; color: #92400e; }
    .cell-tab-count { margin-left: 0.15rem; padding: 0.2rem 0.5rem; min-width: 1.25rem; text-align: center; border-radius: 999px; font-size: 0.75rem; font-weight: 600; }
    .cell-tab[data-cell-filter="difference"] .cell-tab-count { background: #fed7aa; color: #c2410c; }
    .cell-tab[data-cell-filter="difference"].active .cell-tab-count { background: #fcd34d; color: #92400e; }
    .cell-tab[data-cell-filter="missing"] .cell-tab-count { background: #fecaca; color: #991b1b; }
    .cell-tab[data-cell-filter="additional"] .cell-tab-count { background: #bae6fd; color: #0369a1; }
    .cell-level-search-row { display: flex; flex-wrap: wrap; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem; }
    .cell-level-search { flex: 1; min-width: 200px; padding: 0.55rem 0.85rem; border: 1px solid var(--border); border-radius: var(--radius-sm); font-size: 0.875rem; }
    .cell-level-search::placeholder { color: var(--text-muted); }
    .cell-level-found { margin: 0; font-size: 0.8125rem; color: var(--text-muted); }
    .cell-level-table-wrap { overflow-x: auto; margin-bottom: 0.5rem; }
    .cell-level-table { width: 100%; border-collapse: collapse; font-size: 0.875rem; }
    .cell-level-table th { text-align: left; padding: 0.5rem 0.75rem; background: #f8fafc; color: var(--primary); font-weight: 600; border-bottom: 1px solid var(--border); }
    .cell-level-table td { padding: 0.5rem 0.75rem; border-bottom: 1px solid var(--border); vertical-align: middle; }
    .cell-level-table tbody tr:nth-child(even) { background: #fafafa; }
    .cell-level-table tbody tr:nth-child(odd) { background: #fff; }
    .cell-level-table tbody tr:hover { background: var(--primary-light); }
    .th-dot { display: inline-block; width: 6px; height: 6px; border-radius: 50%; margin-right: 0.35rem; vertical-align: middle; }
    .th-dot.expected-dot { background: #dc2626; }
    .th-dot.actual-dot { background: #16a34a; }
    .cell-pill { display: inline-block; padding: 0.25rem 0.5rem; border-radius: 6px; font-size: 0.8125rem; font-weight: 500; }
    .cell-pill.expected { background: #fee2e2; color: #991b1b; }
    .cell-pill.actual { background: #dcfce7; color: #166534; }
    .cell-pill.missing { background: #f1f5f9; color: var(--text-muted); }
    .cell-level-empty { margin: 0.75rem 0 0; font-size: 0.875rem; color: var(--text-muted); font-style: italic; }
    .results-summary .label { display: block; font-size: 0.8125rem; font-weight: 500; color: #374151; margin-bottom: 0.35rem; }
    .results-summary .value { display: block; font-size: 1.5rem; font-weight: 700; color: #1f2937; }
    .config-text { font-size: 0.8125rem; color: var(--text-muted); margin-bottom: 1rem; }
    section.results-section {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 10px;
      margin-bottom: 1rem;
      overflow: hidden;
    }
    section.results-section h2 {
      margin: 0;
      padding: 0.75rem 1rem;
      font-size: 0.9375rem;
      font-weight: 600;
      border-bottom: 1px solid var(--border);
    }
    section.results-section.added h2 { color: var(--added); }
    section.results-section.removed h2 { color: var(--removed); }
    section.results-section.modified h2 { color: var(--modified); }
    .table-wrap { overflow-x: auto; }
    .results-section table { width: 100%; border-collapse: collapse; font-size: 0.875rem; }
    .results-section th, .results-section td { padding: 0.5rem 1rem; text-align: left; border-bottom: 1px solid var(--border); }
    .results-section th { color: var(--text-muted); font-weight: 500; }
    .results-section tr:last-child td { border-bottom: none; }
    .empty-msg { color: var(--text-muted); padding: 1rem; font-style: italic; font-size: 0.875rem; }
    .modified-row { margin: 0.75rem 1rem; padding-bottom: 0.75rem; border-bottom: 1px solid var(--border); }
    .modified-row:last-child { border-bottom: none; }
    .modified-row .id { font-weight: 600; margin-bottom: 0.25rem; font-size: 0.875rem; }
    .modified-row .change { font-size: 0.8125rem; margin-left: 1rem; color: var(--text-muted); }
    .modified-row .change strong { color: var(--text); }
    .modified-row .change .old { color: var(--removed); }
    .modified-row .change .new { color: var(--added); }
    .error-msg { color: var(--removed); padding: 1rem; background: #fef2f2; border-radius: 8px; margin-bottom: 1rem; font-size: 0.875rem; }
    .error-msg .code { font-size: 0.75rem; color: var(--text-muted); margin-top: 0.5rem; }
    .error-msg ul { margin: 0.5rem 0 0 1rem; }

    @media (max-width: 640px) {
      .header { padding: 0.75rem 1rem; flex-wrap: wrap; gap: 0.5rem; }
      .header-title { font-size: 1.1rem; }
      .tabs { margin: 0.75rem 1rem; max-width: none; padding: 4px; }
      .tab { padding: 0.45rem 0.75rem; font-size: 0.75rem; }
      .main { padding: 1rem; }
      .upload-row { padding: 1rem; }
      .upload-col { min-width: 100%; }
      .compare-footer { justify-content: stretch; }
      .btn-compare { width: 100%; justify-content: center; }
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-left">
      <div class="header-icon"><i class="fas fa-table-cells"></i></div>
      <div>
        <h1 class="header-title">Excel Comparison Tool</h1>
        <p class="header-subtitle">Compare and analyze Excel files</p>
      </div>
    </div>
    <div class="header-right">
      <div class="brand-text">
        <p class="brand-name">ABB</p>
        <p class="brand-powered"><span class="brand-powered-caps">Powered by DTC</span><br><span class="brand-powered-normal">Infotech Pvt Ltd</span></p>
      </div>
      <img src="/logo" alt="ABB logo" class="header-logo">
    </div>
  </header>

  <nav class="tabs" aria-label="Excel Comparison, Results and Historic data">
    <button type="button" class="tab active" data-tab="upload" aria-pressed="true" aria-current="page">
      <i class="fas fa-table-cells" aria-hidden="true"></i> Excel Comparison
    </button>
    <button type="button" class="tab" data-tab="results" aria-pressed="false">
      <i class="fas fa-file-lines" aria-hidden="true"></i> Results / Report
    </button>
    <button type="button" class="tab" data-tab="historic" aria-pressed="false" id="tabHistoric">
      <i class="fas fa-history" aria-hidden="true"></i> Historic data
    </button>
  </nav>

  <main class="main">
    <div id="uploadPanel" class="tab-content active">
      <div class="card">
        <div class="card-head">
          <h2 class="card-title">Upload Excel Files</h2>
          <p class="card-subtitle">Upload the Expected and Actual Excel files to compare</p>
        </div>
        <div class="upload-row">
          <div class="upload-col">
            <span class="upload-label">Expected File</span>
            <p class="upload-desc">The baseline Excel file for comparison</p>
            <div class="drop-zone" id="dropExpected" role="button" tabindex="0">
              <i class="fas fa-cloud-arrow-up icon"></i>
              <span class="main-text">Drop your Excel file here</span>
              <span class="sub-text">or click to browse (.xlsx, .xls)</span>
              <input type="file" id="expectedFile" accept=".xlsx,.xls">
            </div>
            <div class="file-card" id="expectedCard" aria-live="polite">
              <div class="file-card-check"><i class="fas fa-check"></i></div>
              <div class="file-card-body">
                <p class="file-card-name" id="expectedCardName"></p>
                <p class="file-card-meta" id="expectedCardMeta"></p>
              </div>
              <button type="button" class="file-card-remove" id="expectedRemove" title="Remove file" aria-label="Remove file"><i class="fas fa-times"></i></button>
            </div>
          </div>
          <div class="upload-col">
            <span class="upload-label">Actual File</span>
            <p class="upload-desc">The file to compare against expected</p>
            <div class="drop-zone" id="dropActual" role="button" tabindex="0">
              <i class="fas fa-cloud-arrow-up icon"></i>
              <span class="main-text">Drop your Excel file here</span>
              <span class="sub-text">or click to browse (.xlsx, .xls)</span>
              <input type="file" id="actualFile" accept=".xlsx,.xls">
            </div>
            <div class="file-card" id="actualCard" aria-live="polite">
              <div class="file-card-check"><i class="fas fa-check"></i></div>
              <div class="file-card-body">
                <p class="file-card-name" id="actualCardName"></p>
                <p class="file-card-meta" id="actualCardMeta"></p>
              </div>
              <button type="button" class="file-card-remove" id="actualRemove" title="Remove file" aria-label="Remove file"><i class="fas fa-times"></i></button>
            </div>
          </div>
        </div>
      </div>

      <div class="card" id="previewCard">
        <div class="card-head">
          <h2 class="card-title">Data preview</h2>
          <p class="card-subtitle">First rows of each uploaded file</p>
        </div>
        <div class="preview-row">
          <div class="preview-col">
            <h3 class="preview-col-title" id="expectedPreviewTitle">Expected File</h3>
            <div class="preview-sheet-row" id="expectedSheetRow" style="display: none;">
              <label class="preview-sheet-label">Sheet:</label>
              <select class="preview-sheet-select" id="expectedSheetSelect"></select>
            </div>
            <div id="expectedPreview" class="preview-placeholder">Upload a file to see preview.</div>
          </div>
          <div class="preview-col">
            <h3 class="preview-col-title" id="actualPreviewTitle">Actual File</h3>
            <div class="preview-sheet-row" id="actualSheetRow" style="display: none;">
              <label class="preview-sheet-label">Sheet:</label>
              <select class="preview-sheet-select" id="actualSheetSelect"></select>
            </div>
            <div id="actualPreview" class="preview-placeholder">Upload a file to see preview.</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="card-head">
          <h2 class="card-title">Comparison Options</h2>
        </div>
        <div class="options-inner">
          <div class="option-group">
            <span class="option-group-label">Comparison Mode</span>
            <div class="mode-cards">
              <label class="mode-card selected" id="modeCardSheetCount" data-mode="sheet_count">
                <input type="radio" name="compareMode" value="sheet_count" checked>
                <div class="mode-card-icon"><i class="fas fa-layer-group"></i></div>
                <div class="mode-card-title">Sheet Count</div>
                <p class="mode-card-desc">Compare total number of sheets and highlight mismatches</p>
              </label>
              <label class="mode-card" id="modeCardSpecific" data-mode="specific">
                <input type="radio" name="compareMode" value="specific">
                <div class="mode-card-icon"><i class="fas fa-table-cells"></i></div>
                <div class="mode-card-title">Specific Sheet Comparison</div>
                <p class="mode-card-desc">Compare specific sheets with cell-by-cell or row-level analysis</p>
              </label>
            </div>
          </div>
          <div id="specificSheetOptions" style="display: none;">
            <div class="option-group">
              <label class="option-group-label">Select Sheet</label>
              <select class="sheet-select-single" id="sheetToCompare">
                <option value="">Choose a sheet to compare</option>
              </select>
            </div>
            <div class="option-group">
              <span class="option-group-label">Comparison Type</span>
              <div class="option-row">
                <label class="option-item"><input type="radio" name="mode" value="position" checked> Cell-by-Cell</label>
                <label class="option-item"><input type="radio" name="mode" value="key"> Row-Level</label>
              </div>
            </div>
            <div class="option-group key-option-group" id="keyOptionGroup" style="display: none;">
              <label class="option-group-label">Primary key column (Row-Level)</label>
              <select class="key-input sheet-select-single" id="keyInput">
                <option value="">Select primary key column</option>
              </select>
            </div>
            <!-- hidden: still used for API when different sheets per file needed later -->
            <select class="key-input sheet-select" id="expectedCompareSheet" aria-hidden="true" style="display: none;"></select>
            <select class="key-input sheet-select" id="actualCompareSheet" aria-hidden="true" style="display: none;"></select>
          </div>
          <div class="enable-export-row">
            <span class="enable-export-label"><i class="fas fa-file-export" aria-hidden="true"></i> Enable Export</span>
            <label class="toggle-switch" aria-label="Enable Export">
              <input type="checkbox" id="enableExportToggle" checked>
              <span class="toggle-slider"></span>
            </label>
          </div>
          <div class="compare-footer">
            <button type="button" class="btn-compare" id="runCompare"><span class="btn-spinner" aria-hidden="true"></span><i class="fas fa-play" aria-hidden="true"></i><span class="btn-text">Compare Files</span></button>
          </div>
        </div>
      </div>

      <div id="uploadError" class="error-msg" style="display: none;"></div>
    </div>

    <div id="resultsPanel" class="tab-content">
      <p class="config-text" id="configText"></p>
      <div id="resultsError" class="error-msg" style="display: none;"></div>
      <div id="resultsEmpty" class="results-empty">
        <i class="fas fa-table-cells"></i>
        <p>Run a comparison from the <strong>Excel Comparison</strong> tab to see results here.</p>
      </div>
      <div id="resultsOut" style="display: none;">
        <div class="results-header" id="resultsHeader">
          <div class="results-meta">
            <span class="results-meta-item"><i class="fas fa-calendar"></i> <span id="resultsDate"></span></span>
            <span class="results-meta-item"><i class="fas fa-clock"></i> <span id="resultsTime"></span></span>
            <span class="results-status" id="resultsStatus"><i class="fas fa-circle status-dot"></i> Comparison Complete</span>
          </div>
          <div class="results-export" id="resultsExport">
            <button type="button" class="btn-export" id="exportHtmlBtn"><i class="fas fa-file-code"></i> HTML</button>
            <button type="button" class="btn-export" id="exportExcelBtn"><i class="fas fa-file-excel"></i> Excel</button>
          </div>
        </div>
        <div class="results-validation-tabs">
          <button type="button" class="validation-tab active" data-validation="sheet" id="tabSheetValidation"><i class="fas fa-layer-group"></i> Sheet Validation</button>
          <button type="button" class="validation-tab" data-validation="cell" id="tabCellValidation"><i class="fas fa-table-cells"></i> Cell Validation</button>
        </div>
        <div id="validationSheetContent" class="validation-content active">
          <div class="sheet-count-summary" id="sheetCountSummaryCard">
            <h3 class="sheet-count-summary-title"><i class="fas fa-table-cells"></i> Sheet Count Summary</h3>
            <div class="sheet-count-cards" id="sheetCountCards">
              <div class="sc-card"><span class="sc-card-label" id="scExpectedLabel">Expected file</span><span class="sc-card-value" id="scExpected">—</span></div>
              <div class="sc-card"><span class="sc-card-label" id="scActualLabel">Actual file</span><span class="sc-card-value" id="scActual">—</span></div>
              <div class="sc-card sc-card-diff"><span class="sc-card-label">Difference</span><span class="sc-card-value" id="scDifference">—</span></div>
            </div>
          </div>
          <div class="sheet-presence-analysis" id="sheetPresenceAnalysis">
            <h3 class="sheet-presence-title"><i class="fas fa-triangle-exclamation"></i> Sheet Presence Analysis</h3>
            <div class="presence-section presence-matched">
              <div class="presence-heading-row">
                <h4 class="presence-heading"><i class="fas fa-check-circle"></i> Matched Sheets</h4>
                <span class="presence-count" id="presenceMatchedCount">0 sheets</span>
              </div>
              <p class="presence-desc" id="presenceMatchedDesc">Sheets found in both files.</p>
              <div class="presence-tags" id="presenceMatchedTags"></div>
            </div>
            <div class="presence-section presence-missing">
              <div class="presence-heading-row">
                <h4 class="presence-heading"><i class="fas fa-minus"></i> Missing Sheets</h4>
                <span class="presence-count" id="presenceMissingCount">0 sheets</span>
              </div>
              <p class="presence-desc">Present in Expected but missing in Actual:</p>
              <div class="presence-tags" id="presenceMissingTags"></div>
            </div>
            <div class="presence-section presence-additional">
              <div class="presence-heading-row">
                <h4 class="presence-heading"><i class="fas fa-plus"></i> Additional Sheets</h4>
                <span class="presence-count" id="presenceAdditionalCount">0 sheets</span>
              </div>
              <p class="presence-desc">Present in Actual but not in Expected:</p>
              <div class="presence-tags" id="presenceAdditionalTags"></div>
            </div>
          </div>
        </div>
        <div id="validationCellContent" class="validation-content">
          <div id="specificResultContent" style="display: none;">
            <div class="results-summary-wrap">
              <div class="results-summary" id="summary"></div>
            </div>
            <section class="results-section added" id="added-section">
              <h2 id="added-title">Added rows</h2>
              <div class="table-wrap" id="added-wrap"></div>
            </section>
            <section class="results-section removed" id="removed-section">
              <h2 id="removed-title">Removed rows</h2>
              <div class="table-wrap" id="removed-wrap"></div>
            </section>
            <section class="results-section modified" id="modified-section">
              <h2 id="modified-title">Modified rows</h2>
              <div class="table-wrap" id="modified-wrap"></div>
            </section>
            <div class="cell-level-results">
              <div class="cell-level-header-row">
                <div>
                  <h2 class="cell-level-title">Cell-Level Comparison Results</h2>
                  <p class="cell-level-subtitle">Detailed view of differences, missing data, and additional data.</p>
                </div>
                <div class="cell-level-export-btns">
                  <button type="button" class="btn-export" id="cellLevelExportHtmlBtn" title="Export cell-level results as HTML"><i class="fas fa-file-code"></i> HTML</button>
                  <button type="button" class="btn-export" id="cellLevelExportExcelBtn" title="Export cell-level results as Excel"><i class="fas fa-file-excel"></i> Excel</button>
                </div>
              </div>
              <div class="cell-level-sheet-select">
                <span class="option-group-label"><i class="fas fa-table-cells" aria-hidden="true"></i> Select Sheet</span>
                <div class="cell-level-sheet-tabs" id="cellLevelSheetTabs" role="tablist"></div>
                <span class="cell-level-sheet-badge" id="cellLevelSheetBadge">0 sheets</span>
              </div>
              <div class="cell-level-tabs" role="tablist">
                <button type="button" class="cell-tab active" data-cell-filter="difference" role="tab" aria-selected="true"><i class="fas fa-triangle-exclamation"></i> <span class="cell-tab-label">Differences</span> <span class="cell-tab-count" id="cellCountDiff">0</span></button>
                <button type="button" class="cell-tab" data-cell-filter="missing" role="tab" aria-selected="false"><i class="fas fa-minus-circle"></i> <span class="cell-tab-label">Missing</span> <span class="cell-tab-count" id="cellCountMissing">0</span></button>
                <button type="button" class="cell-tab" data-cell-filter="additional" role="tab" aria-selected="false"><i class="fas fa-plus-circle"></i> <span class="cell-tab-label">Additional</span> <span class="cell-tab-count" id="cellCountAdditional">0</span></button>
              </div>
              <div class="cell-level-search-row">
                <input type="text" class="cell-level-search" id="cellLevelSearch" placeholder="Search by sheet or column name..." aria-label="Search results">
                <p class="cell-level-found" id="cellLevelFound">Found 0 cell differences</p>
              </div>
              <div class="table-wrap cell-level-table-wrap">
                <table class="cell-level-table" id="cellLevelTable">
                  <thead>
                    <tr>
                      <th>Sheet Name</th>
                      <th>Row</th>
                      <th>Column Name</th>
                      <th><span class="th-dot expected-dot"></span> Expected Value</th>
                      <th><span class="th-dot actual-dot"></span> Actual Value</th>
                    </tr>
                  </thead>
                  <tbody id="cellLevelTableBody"></tbody>
                </table>
              </div>
              <p class="cell-level-empty" id="cellLevelEmpty" style="display: none;">No rows match the selected filter. Try another tab or clear the search.</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="historicPanel" class="tab-content">
      <div class="historic-data-section card">
        <div class="historic-data-body">
          <p class="historic-data-placeholder">Will be available soon</p>
        </div>
      </div>
    </div>
    <footer class="main-footer">ABB • <span class="brand-powered-caps">Powered by DTC</span> <span class="brand-powered-normal">Infotech Pvt Ltd</span></footer>
  </main>

  <script>
    (function() {
      const dropExpected = document.getElementById('dropExpected');
      const dropActual = document.getElementById('dropActual');
      const expectedFile = document.getElementById('expectedFile');
      const actualFile = document.getElementById('actualFile');
      const expectedCard = document.getElementById('expectedCard');
      const actualCard = document.getElementById('actualCard');
      const expectedCardName = document.getElementById('expectedCardName');
      const expectedCardMeta = document.getElementById('expectedCardMeta');
      const actualCardName = document.getElementById('actualCardName');
      const actualCardMeta = document.getElementById('actualCardMeta');
      const keyInput = document.getElementById('keyInput');
      const runBtn = document.getElementById('runCompare');
      const uploadError = document.getElementById('uploadError');
      const resultsError = document.getElementById('resultsError');
      const resultsEmpty = document.getElementById('resultsEmpty');
      const resultsOut = document.getElementById('resultsOut');
      const summaryEl = document.getElementById('summary');
      const addedTitle = document.getElementById('added-title');
      const removedTitle = document.getElementById('removed-title');
      const modifiedTitle = document.getElementById('modified-title');
      const addedWrap = document.getElementById('added-wrap');
      const removedWrap = document.getElementById('removed-wrap');
      const modifiedWrap = document.getElementById('modified-wrap');
      const configText = document.getElementById('configText');
      const tabUpload = document.querySelector('[data-tab="upload"]');
      const tabResults = document.querySelector('[data-tab="results"]');
      const tabHistoric = document.getElementById('tabHistoric');
      const uploadPanel = document.getElementById('uploadPanel');
      const resultsPanel = document.getElementById('resultsPanel');
      const historicPanel = document.getElementById('historicPanel');
      const expectedPreviewEl = document.getElementById('expectedPreview');
      const actualPreviewEl = document.getElementById('actualPreview');
      const expectedSheetRow = document.getElementById('expectedSheetRow');
      const actualSheetRow = document.getElementById('actualSheetRow');
      const expectedSheetSelect = document.getElementById('expectedSheetSelect');
      const actualSheetSelect = document.getElementById('actualSheetSelect');
      const expectedCompareSheet = document.getElementById('expectedCompareSheet');
      const actualCompareSheet = document.getElementById('actualCompareSheet');
      const modeCardSheetCount = document.getElementById('modeCardSheetCount');
      const modeCardSpecific = document.getElementById('modeCardSpecific');
      const specificSheetOptions = document.getElementById('specificSheetOptions');
      const specificResultContent = document.getElementById('specificResultContent');
      const resultsHeader = document.getElementById('resultsHeader');
      const resultsDate = document.getElementById('resultsDate');
      const resultsTime = document.getElementById('resultsTime');
      const resultsExport = document.getElementById('resultsExport');
      const validationSheetContent = document.getElementById('validationSheetContent');
      const validationCellContent = document.getElementById('validationCellContent');
      const tabSheetValidation = document.getElementById('tabSheetValidation');
      const tabCellValidation = document.getElementById('tabCellValidation');
      const scExpected = document.getElementById('scExpected');
      const scActual = document.getElementById('scActual');
      const scDifference = document.getElementById('scDifference');
      const sheetToCompare = document.getElementById('sheetToCompare');
      const keyOptionGroup = document.getElementById('keyOptionGroup');
      const enableExportToggle = document.getElementById('enableExportToggle');
      const cellLevelExportBtns = document.querySelector('.cell-level-export-btns');
      const previewPlaceholderText = 'Upload a file to see preview.';
      let expectedSheetNames = [];
      let actualSheetNames = [];
      let sheetTabNames = [];
      let sheetTabCounts = {};
      let lastCompareData = null; // store latest comparison for export
      let lastSheetCountData = null; // store sheet count comparison for HTML export

      function escapeHtml(s) {
        const div = document.createElement('div');
        div.textContent = s;
        return div.innerHTML;
      }
      function formatSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
      }
      async function fetchFileInfo(file) {
        const fd = new FormData();
        fd.set('file', file);
        try {
          const res = await fetch('/api/file-info', { method: 'POST', body: fd });
          const data = await res.json();
          return res.ok ? { sheets: data.sheets, sheet_names: data.sheet_names || [] } : null;
        } catch (_) { return null; }
      }
      function fillSheetSelect(selectEl, sheetNames, selectIndex) {
        selectEl.innerHTML = '';
        (sheetNames || []).forEach((name, i) => {
          const opt = document.createElement('option');
          opt.value = i;
          opt.textContent = name;
          if (i === selectIndex) opt.selected = true;
          selectEl.appendChild(opt);
        });
      }
      function resetCompareSheetSelect(selectEl) {
        selectEl.innerHTML = '<option value="0">—</option>';
        selectEl.disabled = true;
      }
      function resetSheetToCompare() {
        sheetToCompare.innerHTML = '<option value="">Choose a sheet to compare</option>';
      }
      function fillKeyColumnSelect(columns) {
        if (!keyInput || !columns || !columns.length) return;
        keyInput.innerHTML = '<option value="">Select primary key column</option>';
        columns.forEach(function(col) {
          const opt = document.createElement('option');
          opt.value = col;
          opt.textContent = col;
          keyInput.appendChild(opt);
        });
        keyInput.disabled = false;
        var hasEmpId = columns.indexOf('EMP_ID') !== -1;
        if (hasEmpId) keyInput.value = 'EMP_ID';
        else if (columns[0]) keyInput.value = columns[0];
      }
      function resetKeyColumnSelect() {
        keyInput.innerHTML = '<option value="">Select primary key column</option>';
        keyInput.disabled = true;
      }
      function renderPreview(container, data) {
        if (!data || !data.columns || !data.rows) {
          container.innerHTML = '<span class="preview-placeholder">' + escapeHtml('Could not load preview.') + '</span>';
          return;
        }
        const cols = data.columns;
        const total = data.total_rows != null ? data.total_rows : data.rows.length;
        const tableHtml = '<div class="preview-table-wrap"><table><thead><tr>' +
          cols.map(c => '<th>' + escapeHtml(c) + '</th>').join('') + '</tr></thead><tbody>' +
          data.rows.map(r => '<tr>' + cols.map(c => '<td>' + escapeHtml(String(r[c] ?? '')) + '</td>').join('') + '</tr>').join('') +
          '</tbody></table></div><p class="preview-meta">Showing first ' + data.rows.length + ' of ' + total + ' rows.</p>';
        container.innerHTML = tableHtml;
      }
      async function fetchPreview(file, sheetIndex) {
        const fd = new FormData();
        fd.set('file', file);
        if (sheetIndex != null) fd.set('sheet', String(sheetIndex));
        try {
          const res = await fetch('/api/preview', { method: 'POST', body: fd });
          const data = await res.json();
          return res.ok ? data : null;
        } catch (_) { return null; }
      }
      function clearFileCard(zone, card, nameEl, metaEl, input, previewEl, previewTitleEl, defaultTitle, sheetRow, sheetSelect, compareSheetSelect, isExpected) {
        input.value = '';
        card.classList.remove('visible');
        zone.classList.remove('hidden');
        nameEl.textContent = '';
        metaEl.textContent = '';
        if (previewEl) previewEl.innerHTML = escapeHtml(previewPlaceholderText);
        if (previewTitleEl && defaultTitle) previewTitleEl.textContent = defaultTitle;
        if (sheetRow) sheetRow.style.display = 'none';
        if (sheetSelect) sheetSelect.innerHTML = '';
        if (compareSheetSelect) resetCompareSheetSelect(compareSheetSelect);
        if (isExpected && sheetToCompare) resetSheetToCompare();
        if (isExpected) resetKeyColumnSelect();
      }
      function showFileCard(zone, card, nameEl, metaEl, input, removeBtn, previewEl, previewTitleEl, defaultTitle, sheetRow, sheetSelect, compareSheetSelect, isExpected) {
        const f = input.files?.[0];
        if (!f) return;
        zone.classList.add('hidden');
        card.classList.add('visible');
        nameEl.textContent = f.name;
        metaEl.textContent = formatSize(f.size);
        if (previewTitleEl) previewTitleEl.textContent = f.name;
        if (previewEl) previewEl.innerHTML = 'Loading preview…';
        fetchFileInfo(f).then(info => {
          const sheetNames = (info && info.sheet_names) ? info.sheet_names : [];
          const n = (info && info.sheets != null) ? info.sheets : sheetNames.length;
          if (n != null) metaEl.textContent = formatSize(f.size) + ' · ' + n + ' sheet' + (n !== 1 ? 's' : '');
          fillSheetSelect(sheetSelect, sheetNames, 0);
          if (sheetNames.length > 1 && sheetRow) {
            sheetRow.style.display = 'flex';
            sheetSelect.onchange = () => {
              previewEl.innerHTML = 'Loading preview…';
              fetchPreview(f, parseInt(sheetSelect.value, 10)).then(data => renderPreview(previewEl, data));
            };
          } else if (sheetRow) sheetRow.style.display = 'none';
          if (compareSheetSelect) {
            compareSheetSelect.innerHTML = '';
            sheetNames.forEach((name, i) => {
              const opt = document.createElement('option');
              opt.value = i;
              opt.textContent = name;
              compareSheetSelect.appendChild(opt);
            });
            compareSheetSelect.disabled = sheetNames.length === 0;
          }
          if (isExpected) {
            expectedSheetNames = sheetNames.slice();
            if (sheetToCompare && sheetNames.length) {
              sheetToCompare.innerHTML = '<option value="">Choose a sheet to compare</option>';
              sheetNames.forEach((name, i) => {
                const opt = document.createElement('option');
                opt.value = i;
                opt.textContent = name;
                sheetToCompare.appendChild(opt);
              });
            }
            rebuildSheetTabs(0);
          } else {
            actualSheetNames = sheetNames.slice();
            rebuildSheetTabs(0);
          }
          return fetchPreview(f, 0);
        }).then(data => {
          renderPreview(previewEl, data);
          if (isExpected && data && data.columns && data.columns.length) fillKeyColumnSelect(data.columns);
        });
        removeBtn.onclick = () => clearFileCard(zone, card, nameEl, metaEl, input, previewEl, previewTitleEl, defaultTitle, sheetRow, sheetSelect, compareSheetSelect, isExpected);
      }
      function setupDropZone(zone, input, card, nameEl, metaEl, removeBtn, previewEl, previewTitleEl, defaultTitle, sheetRow, sheetSelect, compareSheetSelect, isExpected) {
        zone.addEventListener('click', () => input.click());
        zone.addEventListener('dragover', (e) => { e.preventDefault(); zone.classList.add('dragover'); });
        zone.addEventListener('dragleave', () => zone.classList.remove('dragover'));
        zone.addEventListener('drop', (e) => {
          e.preventDefault();
          zone.classList.remove('dragover');
          const f = e.dataTransfer?.files?.[0];
          if (f && (f.name.endsWith('.xlsx') || f.name.endsWith('.xls'))) {
            input.files = e.dataTransfer.files;
            showFileCard(zone, card, nameEl, metaEl, input, removeBtn, previewEl, previewTitleEl, defaultTitle, sheetRow, sheetSelect, compareSheetSelect, isExpected);
          }
        });
        input.addEventListener('change', () => {
          if (input.files?.[0]) showFileCard(zone, card, nameEl, metaEl, input, removeBtn, previewEl, previewTitleEl, defaultTitle, sheetRow, sheetSelect, compareSheetSelect, isExpected);
        });
      }
      sheetToCompare.addEventListener('change', function() {
        var f = expectedFile.files && expectedFile.files[0];
        if (!f || !sheetToCompare.value || sheetToCompare.value === '') return;
        fetchPreview(f, parseInt(sheetToCompare.value, 10)).then(function(data) {
          if (data && data.columns && data.columns.length) fillKeyColumnSelect(data.columns);
        });
      });

      resetCompareSheetSelect(expectedCompareSheet);
      resetCompareSheetSelect(actualCompareSheet);
      setupDropZone(dropExpected, expectedFile, expectedCard, expectedCardName, expectedCardMeta, document.getElementById('expectedRemove'), expectedPreviewEl, document.getElementById('expectedPreviewTitle'), 'Expected File', expectedSheetRow, expectedSheetSelect, expectedCompareSheet, true);
      setupDropZone(dropActual, actualFile, actualCard, actualCardName, actualCardMeta, document.getElementById('actualRemove'), actualPreviewEl, document.getElementById('actualPreviewTitle'), 'Actual File', actualSheetRow, actualSheetSelect, actualCompareSheet, false);

      document.querySelectorAll('input[name="compareMode"]').forEach(radio => {
        radio.addEventListener('change', () => {
          document.querySelectorAll('.mode-card').forEach(c => c.classList.remove('selected'));
          const card = document.getElementById(radio.value === 'sheet_count' ? 'modeCardSheetCount' : 'modeCardSpecific');
          if (card) card.classList.add('selected');
          specificSheetOptions.style.display = radio.value === 'specific' ? 'block' : 'none';
        });
      });
      document.querySelectorAll('.mode-card').forEach(card => {
        card.addEventListener('click', () => {
          const mode = card.getAttribute('data-mode');
          const radio = document.querySelector('input[name="compareMode"][value="' + (mode === 'sheet_count' ? 'sheet_count' : 'specific') + '"]');
          if (radio) { radio.checked = true; radio.dispatchEvent(new Event('change')); }
        });
      });

      document.querySelectorAll('input[name="mode"]').forEach(radio => {
        radio.addEventListener('change', () => {
          const isRowLevel = document.querySelector('input[name="mode"]:checked').value === 'key';
          keyInput.disabled = !isRowLevel;
          keyOptionGroup.style.display = isRowLevel ? 'block' : 'none';
        });
      });
      keyOptionGroup.style.display = 'none';
      resetKeyColumnSelect();

      function showUploadError(msg) {
        uploadError.innerHTML = escapeHtml(msg);
        uploadError.style.display = 'block';
      }
      function hideUploadError() {
        uploadError.style.display = 'none';
      }
      function showResultsError(data) {
        const msg = typeof data === 'string' ? data : (data.error || 'Something went wrong');
        let html = escapeHtml(msg);
        if (data.code === 'primary_key_missing' && (data.columns_file1 || data.columns_file2)) {
          html += '<div class="code">Use a column that exists in both files.</div>';
          if (data.columns_file1?.length)
            html += '<div class="code">File1 columns: ' + data.columns_file1.map(escapeHtml).join(', ') + '</div>';
          if (data.columns_file2?.length)
            html += '<div class="code">File2 columns: ' + data.columns_file2.map(escapeHtml).join(', ') + '</div>';
        } else if (data.code) {
          html += '<div class="code">' + escapeHtml(data.code) + '</div>';
        }
        resultsError.innerHTML = html;
        resultsError.style.display = 'block';
        resultsOut.style.display = 'none';
        resultsEmpty.style.display = 'none';
      }
      function hideResultsError() {
        resultsError.style.display = 'none';
        resultsOut.style.display = 'block';
        resultsEmpty.style.display = 'none';
      }
      function showResultsEmpty() {
        resultsError.style.display = 'none';
        resultsOut.style.display = 'none';
        resultsEmpty.style.display = 'block';
      }

      function renderSummary(s) {
        summaryEl.innerHTML = `
          <div class="card added"><span class="label">Added</span><div class="value">${s.added_count}</div></div>
          <div class="card removed"><span class="label">Removed</span><div class="value">${s.removed_count}</div></div>
          <div class="card modified"><span class="label">Modified</span><div class="value">${s.modified_count}</div></div>
        `;
      }
      function renderTable(rows, wrap) {
        if (!rows || rows.length === 0) {
          wrap.innerHTML = '<p class="empty-msg">No rows</p>';
          return 0;
        }
        const cols = Object.keys(rows[0]);
        wrap.innerHTML = '<table><thead><tr>' + cols.map(c => '<th>' + escapeHtml(c) + '</th>').join('') + '</tr></thead><tbody>' +
          rows.map(r => '<tr>' + cols.map(c => '<td>' + escapeHtml(String(r[c] ?? '')) + '</td>').join('') + '</tr>').join('') + '</tbody></table>';
        return rows.length;
      }
      function renderModified(modifiedRows) {
        if (!modifiedWrap) return 0;
        if (!modifiedRows || modifiedRows.length === 0) {
          modifiedWrap.innerHTML = '<p class="empty-msg">No modified rows</p>';
          return 0;
        }
        modifiedWrap.innerHTML = modifiedRows.map(row =>
          '<div class="modified-row"><div class="id">ID: ' + escapeHtml(row.id) + '</div>' +
          row.changes.map(ch => '<div class="change"><strong>' + escapeHtml(ch.column) + '</strong>: <span class="old">' + escapeHtml(String(ch.old_value ?? '')) + '</span> → <span class="new">' + escapeHtml(String(ch.new_value ?? '')) + '</span></div>').join('') +
          '</div>'
        ).join('');
        return modifiedRows.length;
      }

      var cellLevelRows = [];
      var cellLevelFilter = 'difference';
      var cellLevelShowMatched = false;
      var sheetNameForCell = 'Sheet';
      function buildCellLevelRows(data) {
        var rows = [];
        sheetNameForCell = data.config && data.config.sheet_name ? data.config.sheet_name : 'Sheet';
        (data.modified_rows || []).forEach(function(row) {
          var rowId = row.id || row.row_index != null ? 'Row ' + row.row_index : '';
          (row.changes || []).forEach(function(ch) {
            rows.push({ type: 'difference', sheetName: sheetNameForCell, row: rowId, column: ch.column, expected: ch.old_value, actual: ch.new_value });
          });
        });
        var keyCol = (data.config && data.config.key) ? data.config.key : null;
        (data.removed_rows || []).forEach(function(r, idx) {
          var rowId = 'Row ' + (idx + 1);
          if (typeof r === 'object' && r !== null) {
            if (keyCol && r[keyCol] != null) rowId = String(r[keyCol]);
            else rowId = r.EMP_ID != null ? r.EMP_ID : r.ID != null ? r.ID : (Object.values(r)[0] != null ? Object.values(r)[0] : rowId);
          }
          Object.keys(r || {}).forEach(function(col) {
            rows.push({ type: 'missing', sheetName: sheetNameForCell, row: rowId, column: col, expected: r[col], actual: '\u2014' });
          });
        });
        (data.added_rows || []).forEach(function(r, idx) {
          var rowId = 'Row ' + (idx + 1);
          if (typeof r === 'object' && r !== null) {
            if (keyCol && r[keyCol] != null) rowId = String(r[keyCol]);
            else rowId = r.EMP_ID != null ? r.EMP_ID : r.ID != null ? r.ID : (Object.values(r)[0] != null ? Object.values(r)[0] : rowId);
          }
          Object.keys(r || {}).forEach(function(col) {
            rows.push({ type: 'additional', sheetName: sheetNameForCell, row: rowId, column: col, expected: '\u2014', actual: r[col] });
          });
        });
        cellLevelRows = rows;
      }
      function getCellLevelCounts() {
        var d = 0, m = 0, a = 0;
        cellLevelRows.forEach(function(r) {
          if (r.type === 'difference') d++;
          else if (r.type === 'missing') m++;
          else if (r.type === 'additional') a++;
        });
        return { difference: d, missing: m, additional: a };
      }
      function filterCellLevelRows() {
        var q = (document.getElementById('cellLevelSearch').value || '').toLowerCase();
        return cellLevelRows.filter(function(r) {
          if (r.type !== cellLevelFilter) return false;
          if (!q) return true;
          return (r.sheetName + ' ' + r.column).toLowerCase().indexOf(q) !== -1;
        });
      }
      function renderCellLevelTable() {
        var filtered = filterCellLevelRows();
        var tbody = document.getElementById('cellLevelTableBody');
        var foundEl = document.getElementById('cellLevelFound');
        var emptyEl = document.getElementById('cellLevelEmpty');
        var labels = { difference: 'cell differences', missing: 'missing cells', additional: 'additional cells' };
        foundEl.textContent = 'Found ' + filtered.length + ' ' + (labels[cellLevelFilter] || '');
        if (filtered.length === 0) {
          tbody.innerHTML = '';
          emptyEl.style.display = 'block';
          return;
        }
        emptyEl.style.display = 'none';
        tbody.innerHTML = filtered.map(function(r) {
          var exp = r.expected != null && r.expected !== '' ? '<span class="cell-pill expected">' + escapeHtml(String(r.expected)) + '</span>' : '<span class="cell-pill missing">' + escapeHtml(String(r.expected === '\u2014' ? '\u2014' : r.expected || '')) + '</span>';
          var act = r.actual != null && r.actual !== '' && r.actual !== '\u2014' ? '<span class="cell-pill actual">' + escapeHtml(String(r.actual)) + '</span>' : '<span class="cell-pill missing">' + escapeHtml(String(r.actual === '\u2014' ? '\u2014' : r.actual || '')) + '</span>';
          return '<tr><td>' + escapeHtml(r.sheetName) + '</td><td>' + escapeHtml(String(r.row)) + '</td><td>' + escapeHtml(r.column) + '</td><td>' + exp + '</td><td>' + act + '</td></tr>';
        }).join('');
      }
      function setCellLevelFilter(filter) {
        cellLevelFilter = filter;
        document.querySelectorAll('.cell-tab').forEach(function(t) {
          t.classList.toggle('active', t.getAttribute('data-cell-filter') === filter);
          t.setAttribute('aria-selected', t.getAttribute('data-cell-filter') === filter);
        });
        renderCellLevelTable();
      }
      document.querySelectorAll('.cell-tab').forEach(function(btn) {
        btn.addEventListener('click', function() {
          setCellLevelFilter(btn.getAttribute('data-cell-filter'));
        });
      });
      document.getElementById('cellLevelSearch').addEventListener('input', renderCellLevelTable);

      function buildSheetTabs(names, activeIndex) {
        var badgeEl = document.getElementById('cellLevelSheetBadge');
        var tabsEl = document.getElementById('cellLevelSheetTabs');
        sheetTabNames = names || [];
        if (badgeEl) badgeEl.textContent = sheetTabNames.length + ' sheet' + (sheetTabNames.length === 1 ? '' : 's');
        if (!tabsEl) return;
        tabsEl.innerHTML = sheetTabNames.map(function(name, i) {
          var count = sheetTabCounts[name];
          var isOk = count === 0;
          var badge = count == null ? '' : (isOk ? '<span class="sheet-tab-count"><i class="fas fa-check"></i></span>' : '<span class="sheet-tab-count">' + count + '</span>');
          var activeClass = i === activeIndex ? ' active' : '';
          var okClass = isOk ? ' sheet-ok' : '';
          return '<button type="button" class="cell-level-sheet-tab' + activeClass + okClass + '" data-sheet-idx="' + i + '"><i class="fas fa-table-cells" aria-hidden="true"></i> ' + escapeHtml(name) + (badge ? ' ' + badge : '') + '</button>';
        }).join('');
        tabsEl.querySelectorAll('.cell-level-sheet-tab').forEach(function(btn) {
          btn.addEventListener('click', function() {
            var idx = parseInt(btn.getAttribute('data-sheet-idx'), 10);
            if (!isNaN(idx)) runCompareForSheet(idx);
          });
        });
      }

      function rebuildSheetTabs(activeIdx) {
        const n = Math.min(expectedSheetNames.length, actualSheetNames.length);
        if (n <= 0) {
          buildSheetTabs([], 0);
          return;
        }
        const limitedNames = expectedSheetNames.slice(0, n);
        buildSheetTabs(limitedNames, Math.min(activeIdx || 0, n - 1));
      }

      tabUpload.addEventListener('click', () => {
        tabUpload.classList.add('active');
        tabUpload.setAttribute('aria-pressed', 'true');
        tabResults.classList.remove('active');
        tabResults.setAttribute('aria-pressed', 'false');
        tabHistoric.classList.remove('active');
        tabHistoric.setAttribute('aria-pressed', 'false');
        uploadPanel.classList.add('active');
        resultsPanel.classList.remove('active');
        historicPanel.classList.remove('active');
      });
      tabResults.addEventListener('click', () => {
        tabResults.classList.add('active');
        tabResults.setAttribute('aria-pressed', 'true');
        tabUpload.classList.remove('active');
        tabUpload.setAttribute('aria-pressed', 'false');
        tabHistoric.classList.remove('active');
        tabHistoric.setAttribute('aria-pressed', 'false');
        resultsPanel.classList.add('active');
        uploadPanel.classList.remove('active');
        historicPanel.classList.remove('active');
      });
      tabHistoric.addEventListener('click', () => {
        tabHistoric.classList.add('active');
        tabHistoric.setAttribute('aria-pressed', 'true');
        tabUpload.classList.remove('active');
        tabUpload.setAttribute('aria-pressed', 'false');
        tabResults.classList.remove('active');
        tabResults.setAttribute('aria-pressed', 'false');
        historicPanel.classList.add('active');
        uploadPanel.classList.remove('active');
        resultsPanel.classList.remove('active');
      });

      function setResultsDateTime() {
        const d = new Date();
        resultsDate.textContent = d.toLocaleDateString('en-US', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' });
        resultsTime.textContent = d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: true });
      }
      function showValidationTab(name) {
        document.querySelectorAll('.validation-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.validation-content').forEach(c => c.classList.remove('active'));
        if (name === 'sheet') {
          tabSheetValidation.classList.add('active');
          validationSheetContent.classList.add('active');
        } else {
          tabCellValidation.classList.add('active');
          validationCellContent.classList.add('active');
        }
      }
      tabSheetValidation.addEventListener('click', () => showValidationTab('sheet'));
      tabCellValidation.addEventListener('click', () => showValidationTab('cell'));

      function applyExportVisibility() {
        var on = enableExportToggle && enableExportToggle.checked;
        if (resultsExport) resultsExport.style.display = on ? 'flex' : 'none';
        if (cellLevelExportBtns) cellLevelExportBtns.style.display = on ? 'flex' : 'none';
      }
      if (enableExportToggle) {
        enableExportToggle.addEventListener('change', applyExportVisibility);
      }

      document.getElementById('exportHtmlBtn').addEventListener('click', function() {
        // Sheet count comparison only: export sheet validation report
        if (lastSheetCountData && (!lastCompareData || !lastCompareData.data)) {
          const d = lastSheetCountData;
          const tsDate = (d.timestamp && d.timestamp.date) || new Date().toLocaleDateString();
          const tsTime = (d.timestamp && d.timestamp.time) || new Date().toLocaleTimeString();
          const diff = d.expected_sheets - d.actual_sheets;
          const diffText = (diff > 0 ? '+' : '') + diff;
          function esc(s) {
            const div = document.createElement('div');
            div.textContent = s == null ? '' : String(s);
            return div.innerHTML;
          }
          function renderTags(names) {
            if (!names || !names.length) return '<span class="presence-none">None</span>';
            return names.map(function(n) { return '<span class="presence-tag">' + esc(n) + '</span>'; }).join('');
          }
          const html = '<!DOCTYPE html>\n<html lang="en">\n<head>\n  <meta charset="UTF-8">\n  <meta name="viewport" content="width=device-width, initial-scale=1.0">\n  <title>Sheet Validation Report - ' + esc(tsDate) + '</title>\n  <style>\n    * { margin: 0; padding: 0; box-sizing: border-box; }\n    body { font-family: -apple-system, BlinkMacSystemFont, \'Segoe UI\', Roboto, \'Helvetica Neue\', Arial, sans-serif; background: #f8fafc; color: #1e293b; line-height: 1.6; padding: 2rem; }\n    .container { max-width: 900px; margin: 0 auto; }\n    .header { background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%); color: white; padding: 2rem; border-radius: 12px; margin-bottom: 2rem; }\n    .header h1 { font-size: 1.75rem; margin-bottom: 0.5rem; }\n    .timestamp { display: flex; gap: 2rem; margin-top: 1rem; font-size: 0.9rem; opacity: 0.9; }\n    .section { background: white; border-radius: 12px; margin-bottom: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow: hidden; }\n    .section h2 { font-size: 1.125rem; padding: 1rem 1.5rem; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; gap: 0.5rem; }\n    .section-body { padding: 1.25rem 1.5rem; }\n    .sheet-count-cards { display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; }\n    .sc-card { background: #f8fafc; border-radius: 8px; padding: 1rem; text-align: center; }\n    .sc-card-label { display: block; font-size: 0.8125rem; color: #64748b; margin-bottom: 0.25rem; }\n    .sc-card-value { font-size: 1.5rem; font-weight: 700; }\n    .sc-card-diff { border-left: 4px solid #f59e0b; }\n    .sc-card-diff.match { border-left-color: #22c55e; }\n    .presence-section { margin-bottom: 1.25rem; }\n    .presence-section:last-child { margin-bottom: 0; }\n    .presence-heading-row { display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 0.5rem; }\n    .presence-heading { font-size: 1rem; display: flex; align-items: center; gap: 0.5rem; }\n    .presence-count { font-size: 0.875rem; color: #64748b; font-weight: 600; }\n    .presence-desc { font-size: 0.875rem; color: #64748b; margin-bottom: 0.5rem; }\n    .presence-tags, .presence-tag { display: inline; }\n    .presence-tag { background: #e2e8f0; color: #475569; padding: 0.2rem 0.5rem; border-radius: 6px; margin-right: 0.35rem; margin-bottom: 0.35rem; font-size: 0.8125rem; }\n    .presence-matched .presence-tag { background: #dcfce7; color: #166534; }\n    .presence-missing .presence-tag { background: #fee2e2; color: #991b1b; }\n    .presence-additional .presence-tag { background: #dbeafe; color: #1e40af; }\n    .presence-none { font-size: 0.875rem; color: #94a3b8; }\n    .footer { text-align: center; padding: 2rem; color: #94a3b8; font-size: 0.875rem; }\n    @media print { body { padding: 1rem; } .section { break-inside: avoid; } }\n  </style>\n</head>\n<body>\n  <div class="container">\n    <div class="header">\n      <h1>Sheet Validation Report</h1>\n      <p>Sheet count and presence comparison between Expected and Actual files</p>\n      <div class="timestamp">\n        <span>\uD83D\uDCC5 ' + esc(tsDate) + '</span>\n        <span>\uD83D\uDD50 ' + esc(tsTime) + '</span>\n      </div>\n    </div>\n    <div class="section">\n      <h2>Sheet Count Summary</h2>\n      <div class="section-body">\n        <div class="sheet-count-cards">\n          <div class="sc-card">\n            <span class="sc-card-label">' + esc(d.expected_filename) + '</span>\n            <span class="sc-card-value">' + esc(d.expected_sheets) + '</span>\n          </div>\n          <div class="sc-card">\n            <span class="sc-card-label">' + esc(d.actual_filename) + '</span>\n            <span class="sc-card-value">' + esc(d.actual_sheets) + '</span>\n          </div>\n          <div class="sc-card sc-card-diff' + (diff === 0 ? ' match' : '') + '">\n            <span class="sc-card-label">Difference</span>\n            <span class="sc-card-value">' + esc(diffText) + '</span>\n          </div>\n        </div>\n      </div>\n    </div>\n    <div class="section">\n      <h2>Sheet Presence Analysis</h2>\n      <div class="section-body">\n        <div class="presence-section presence-matched">\n          <div class="presence-heading-row">\n            <span class="presence-heading">\u2713 Matched Sheets</span>\n            <span class="presence-count">' + esc(d.matched.length) + ' sheet' + (d.matched.length !== 1 ? 's' : '') + '</span>\n          </div>\n          <p class="presence-desc">Sheets found in both files.</p>\n          <div class="presence-tags">' + renderTags(d.matched) + '</div>\n        </div>\n        <div class="presence-section presence-missing">\n          <div class="presence-heading-row">\n            <span class="presence-heading">\u2212 Missing Sheets</span>\n            <span class="presence-count">' + esc(d.missing.length) + ' sheet' + (d.missing.length !== 1 ? 's' : '') + '</span>\n          </div>\n          <p class="presence-desc">Present in Expected but missing in Actual:</p>\n          <div class="presence-tags">' + renderTags(d.missing) + '</div>\n        </div>\n        <div class="presence-section presence-additional">\n          <div class="presence-heading-row">\n            <span class="presence-heading">+ Additional Sheets</span>\n            <span class="presence-count">' + esc(d.additional.length) + ' sheet' + (d.additional.length !== 1 ? 's' : '') + '</span>\n          </div>\n          <p class="presence-desc">Present in Actual but not in Expected:</p>\n          <div class="presence-tags">' + renderTags(d.additional) + '</div>\n        </div>\n      </div>\n    </div>\n    <div class="footer">Generated by Excel Comparison Tool \u2022 Sheet Validation Report</div>\n  </div>\n</body>\n</html>';
          const blob = new Blob([html], { type: 'text/html' });
          const url = URL.createObjectURL(blob);
          window.open(url, '_blank');
          setTimeout(function() { URL.revokeObjectURL(url); }, 30000);
          return;
        }
        // Cell/sheet comparison: export comparison report
        if (!lastCompareData || !lastCompareData.data) {
          alert('Run a comparison first to export the report (Sheet count or specific sheet comparison).');
          return;
        }
        const d = lastCompareData;
          const counts = d.counts || { difference: 0, missing: 0, additional: 0 };
        const cellRows = (d.cellRows || []).filter(r => r.type === 'difference' || r.type === 'missing' || r.type === 'additional');
        const addedRows = d.data.added_rows || [];
        const removedRows = d.data.removed_rows || [];
        const modifiedRows = d.data.modified_rows || [];
        const tsDate = resultsDate.textContent || new Date().toLocaleDateString();
        const tsTime = resultsTime.textContent || new Date().toLocaleTimeString();
        const sheetName = d.sheetName || 'Sheet';

        function esc(s) {
          const div = document.createElement('div');
          div.textContent = s == null ? '' : String(s);
          return div.innerHTML;
        }
        function renderTableRows(rows, typeLabel) {
          if (!rows || !rows.length) return '<tr><td colspan="6" style="text-align:center;color:#94a3b8;">No ' + esc(typeLabel) + ' rows</td></tr>';
          return rows.map(r => {
            const exp = r.expected === undefined ? '' : r.expected;
            const act = r.actual === undefined ? '' : r.actual;
            return '<tr>' +
              '<td>' + esc(r.type || typeLabel) + '</td>' +
              '<td>' + esc(r.sheetName || sheetName) + '</td>' +
              '<td>' + esc(r.row || '') + '</td>' +
              '<td>' + esc(r.column || '') + '</td>' +
              '<td><span class="value-expected">' + esc(exp === '\u2014' ? '' : exp) + '</span></td>' +
              '<td><span class="value-actual">' + esc(act === '\u2014' ? '' : act) + '</span></td>' +
            '</tr>';
          }).join('');
        }
        function renderObjTable(arr, title) {
          if (!arr || !arr.length) return '<div class="empty-state"><div class="icon">\u2139\uFE0F</div><div>No ' + esc(title) + '</div></div>';
          const cols = Object.keys(arr[0] || {});
          const header = cols.map(c => '<th>' + esc(c) + '</th>').join('');
          const body = arr.map(row => '<tr>' + cols.map(c => '<td>' + esc(row[c]) + '</td>').join('') + '</tr>').join('');
          return '<table><thead><tr>' + header + '</tr></thead><tbody>' + body + '</tbody></table>';
        }

        const html = `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Excel Comparison Report - ${esc(tsDate)}</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; background: #f8fafc; color: #1e293b; line-height: 1.6; padding: 2rem; }
    .container { max-width: 1200px; margin: 0 auto; }
    .header { background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; padding: 2rem; border-radius: 12px; margin-bottom: 2rem; }
    .header h1 { font-size: 1.75rem; margin-bottom: 0.5rem; }
    .timestamp { display: flex; gap: 2rem; margin-top: 1rem; font-size: 0.9rem; opacity: 0.9; }
    .timestamp-item { display: flex; align-items: center; gap: 0.5rem; }
    .summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
    .summary-card { background: white; border-radius: 8px; padding: 1.25rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); border-left: 4px solid; }
    .summary-card.differences { border-left-color: #f59e0b; }
    .summary-card.missing { border-left-color: #ef4444; }
    .summary-card.additional { border-left-color: #3b82f6; }
    .summary-card.matched { border-left-color: #22c55e; }
    .summary-card h3 { font-size: 0.875rem; color: #64748b; margin-bottom: 0.25rem; }
    .summary-card .count { font-size: 2rem; font-weight: 700; }
    .section { background: white; border-radius: 12px; margin-bottom: 2rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow: hidden; }
    .section-header { padding: 1rem 1.5rem; border-bottom: 1px solid #e2e8f0; display: flex; align-items: center; gap: 0.75rem; }
    .section-header h2 { font-size: 1.125rem; }
    .section-header .badge { background: #f1f5f9; color: #475569; padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600; }
    table { width: 100%; border-collapse: collapse; }
    th { background: #f8fafc; text-align: left; padding: 0.75rem 1rem; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; color: #64748b; border-bottom: 1px solid #e2e8f0; }
    td { padding: 0.75rem 1rem; border-bottom: 1px solid #f1f5f9; font-size: 0.875rem; }
    tr:hover { background: #f8fafc; }
    .value-expected { display: inline-block; background: #fef2f2; color: #dc2626; padding: 0.25rem 0.5rem; border-radius: 4px; font-family: monospace; }
    .value-actual { display: inline-block; background: #f0fdf4; color: #16a34a; padding: 0.25rem 0.5rem; border-radius: 4px; font-family: monospace; }
    .empty-state { padding: 3rem; text-align: center; color: #64748b; }
    .empty-state .icon { font-size: 2rem; margin-bottom: 0.5rem; }
    .footer { text-align: center; padding: 2rem; color: #94a3b8; font-size: 0.875rem; }
    @media print { body { padding: 1rem; } .section { break-inside: avoid; } }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>\uD83D\uDCCA Excel Comparison Report</h1>
      <p>Cell-level comparison analysis between Expected and Actual files</p>
      <div class="timestamp">
        <div class="timestamp-item"><span>\uD83D\uDCC5</span><span>${esc(tsDate)}</span></div>
        <div class="timestamp-item"><span>\uD83D\uDD50</span><span>${esc(tsTime)}</span></div>
      </div>
    </div>

    <div class="summary-cards">
      <div class="summary-card differences"><h3>Differences</h3><div class="count">${esc(counts.difference)}</div></div>
      <div class="summary-card missing"><h3>Missing</h3><div class="count">${esc(counts.missing)}</div></div>
      <div class="summary-card additional"><h3>Additional</h3><div class="count">${esc(counts.additional)}</div></div>
    </div>

    <div class="section">
      <div class="section-header"><h2>Cell-Level Differences</h2><span class="badge">${esc(cellRows.length)} rows</span></div>
      <div class="section-body">
        <table>
          <thead><tr><th>Type</th><th>Sheet</th><th>Row</th><th>Column</th><th>Expected</th><th>Actual</th></tr></thead>
          <tbody>${renderTableRows(cellRows, 'difference')}</tbody>
        </table>
      </div>
    </div>

    <div class="section">
      <div class="section-header"><h2>Added Rows (Actual only)</h2><span class="badge">${esc(addedRows.length)} rows</span></div>
      <div class="section-body">${renderObjTable(addedRows, 'added')}</div>
    </div>
    <div class="section">
      <div class="section-header"><h2>Removed Rows (Expected only)</h2><span class="badge">${esc(removedRows.length)} rows</span></div>
      <div class="section-body">${renderObjTable(removedRows, 'removed')}</div>
    </div>
    <div class="section">
      <div class="section-header"><h2>Modified Rows</h2><span class="badge">${esc(modifiedRows.length)} rows</span></div>
      <div class="section-body">${renderObjTable(modifiedRows, 'modified')}</div>
    </div>

    <div class="footer">Generated by Excel Comparison Tool</div>
  </div>
</body>
</html>`;

        const blob = new Blob([html], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        window.open(url, '_blank');
        setTimeout(function() { URL.revokeObjectURL(url); }, 30000);
      });

      document.getElementById('exportExcelBtn').addEventListener('click', function() {
        var f1 = expectedFile.files && expectedFile.files[0];
        var f2 = actualFile.files && actualFile.files[0];
        if (!f1 || !f2) { alert('Please upload both files again and run comparison before exporting Excel.'); return; }
        var formData = new FormData();
        var useKey = document.querySelector('input[name="mode"]:checked').value === 'key';
        formData.set('key', useKey ? (keyInput.value && keyInput.value.trim()) || 'EMP_ID' : 'none');
        formData.set('expected_sheet', (sheetToCompare && sheetToCompare.value !== '') ? sheetToCompare.value : '0');
        formData.set('actual_sheet', (sheetToCompare && sheetToCompare.value !== '') ? sheetToCompare.value : '0');
        formData.set('expected_file', f1);
        formData.set('actual_file', f2);
        fetch('/api/export-excel', { method: 'POST', body: formData })
          .then(function(r) { if (!r.ok) return r.json().then(function(d) { throw new Error(d.error || 'Export failed'); }); return r.blob(); })
          .then(function(blob) {
            var url = URL.createObjectURL(blob);
            window.open(url, '_blank');
            setTimeout(function() { URL.revokeObjectURL(url); }, 30000);
          })
          .catch(function(e) { alert(e.message || 'Export failed'); });
      });

      function getCellLevelExportRows() {
        return filterCellLevelRows();
      }
      document.getElementById('cellLevelExportHtmlBtn').addEventListener('click', function() {
        var rows = getCellLevelExportRows();
        var tableRows = rows.map(function(r) {
          var exp = r.expected != null && r.expected !== '' ? escapeHtml(String(r.expected)) : (r.expected === '\u2014' ? '\u2014' : escapeHtml(String(r.expected || '')));
          var act = r.actual != null && r.actual !== '' && r.actual !== '\u2014' ? escapeHtml(String(r.actual)) : (r.actual === '\u2014' ? '\u2014' : escapeHtml(String(r.actual || '')));
          return '<tr><td>' + escapeHtml(r.sheetName) + '</td><td>' + escapeHtml(String(r.row)) + '</td><td>' + escapeHtml(r.column) + '</td><td>' + exp + '</td><td>' + act + '</td></tr>';
        });
        var html = '<!DOCTYPE html><html><head><meta charset="utf-8"><title>Cell-Level Comparison Report</title><style>table{border-collapse:collapse;width:100%;}th,td{border:1px solid #ddd;padding:8px;text-align:left;}th{background:#f1f5f9;}</style></head><body>' +
          '<h1>Cell-Level Comparison Results</h1><p>Exported ' + rows.length + ' row(s). Filter: ' + escapeHtml(cellLevelFilter) + '</p>' +
          '<table><thead><tr><th>Sheet Name</th><th>Row</th><th>Column Name</th><th>Expected Value</th><th>Actual Value</th></tr></thead><tbody>' + tableRows.join('') + '</tbody></table></body></html>';
        var blob = new Blob([html], { type: 'text/html' });
        var url = URL.createObjectURL(blob);
        window.open(url, '_blank');
        setTimeout(function() { URL.revokeObjectURL(url); }, 30000);
      });
      document.getElementById('cellLevelExportExcelBtn').addEventListener('click', function() {
        var rows = getCellLevelExportRows();
        if (rows.length === 0) { alert('No cell-level data to export. Run a comparison and ensure Cell Validation has results.'); return; }
        fetch('/api/export-cell-level-excel', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ rows: rows })
        })
          .then(function(r) { if (!r.ok) return r.json().then(function(d) { throw new Error(d.error || 'Export failed'); }); return r.blob(); })
          .then(function(blob) {
            var url = URL.createObjectURL(blob);
            window.open(url, '_blank');
            setTimeout(function() { URL.revokeObjectURL(url); }, 30000);
          })
          .catch(function(e) { alert(e.message || 'Export failed'); });
      });

      async function runSpecificComparison(sheetIndex) {
        const f1 = expectedFile.files?.[0];
        const f2 = actualFile.files?.[0];
        hideUploadError();
        if (!f1 || !f2) {
          showUploadError('Please upload both Expected and Actual Excel files.');
          return null;
        }
        const useKey = document.querySelector('input[name="mode"]:checked').value === 'key';
        const key = useKey ? (keyInput.value && keyInput.value.trim()) || 'EMP_ID' : 'none';
        const formData = new FormData();
        formData.set('key', key);
        const sheetIndexVal = (sheetIndex != null) ? String(sheetIndex) : ((sheetToCompare && sheetToCompare.value !== '') ? sheetToCompare.value : '0');
        formData.set('expected_sheet', sheetIndexVal);
        formData.set('actual_sheet', sheetIndexVal);
        formData.set('expected_file', f1);
        formData.set('actual_file', f2);
        const res = await fetch('/api/compare', { method: 'POST', body: formData });
        const data = await res.json();
        return { ok: res.ok, data, sheetIndex: sheetIndexVal };
      }

      async function runCompareForSheet(sheetIdx) {
        const maxSheets = Math.min(expectedSheetNames.length || 0, actualSheetNames.length || 0);
        if (sheetIdx == null || isNaN(sheetIdx) || sheetIdx < 0 || sheetIdx >= maxSheets) {
            showResultsError({ error: 'Sheet index ' + sheetIdx + ' is invalid; only ' + maxSheets + ' sheet' + (maxSheets === 1 ? '' : 's') + ' available in both files.' });
            resultsOut.style.display = 'none';
            return;
        }
        runBtn.disabled = true;
        runBtn.classList.add('loading');
        var btnText = runBtn.querySelector('.btn-text');
        var btnIcon = runBtn.querySelector('.fa-play');
        if (btnText) btnText.textContent = 'Comparing…';
        if (btnIcon) btnIcon.style.display = 'none';
        try {
          const result = await runSpecificComparison(sheetIdx);
          if (!result) return;
          const { ok, data, sheetIndex } = result;
          if (!ok) {
            showResultsError(data);
            resultsOut.style.display = 'none';
            return;
          }
          hideResultsError();
          setResultsDateTime();
          applyExportVisibility();
          specificResultContent.style.display = 'block';
          const config = data.config || {};
          configText.innerHTML = 'Comparing <code>' + escapeHtml(String(config.file1 || 'file1')) + '</code> vs <code>' + escapeHtml(String(config.file2 || 'file2')) + '</code>' +
            (config.mode === 'position' ? ' (by row position)' : ' (primary key: ' + escapeHtml(String(config.key || 'EMP_ID')) + ')');
          renderSummary(data.summary);
          if (addedWrap) { const nAdded = renderTable(data.added_rows, addedWrap); if (addedTitle) addedTitle.textContent = 'Added rows' + (nAdded ? ' (' + nAdded + ')' : ''); }
          if (removedWrap) { const nRemoved = renderTable(data.removed_rows, removedWrap); if (removedTitle) removedTitle.textContent = 'Removed rows' + (nRemoved ? ' (' + nRemoved + ')' : ''); }
          if (modifiedWrap) { const nModified = renderModified(data.modified_rows); if (modifiedTitle) modifiedTitle.textContent = 'Modified rows' + (nModified ? ' (' + nModified + ')' : ''); }
          buildCellLevelRows(data);
          var counts = getCellLevelCounts();
          document.getElementById('cellCountDiff').textContent = counts.difference;
          document.getElementById('cellCountMissing').textContent = counts.missing;
          document.getElementById('cellCountAdditional').textContent = counts.additional;
          var totalIssues = counts.difference + counts.missing + counts.additional;
          var sheetName = (sheetTabNames && sheetTabNames[sheetIdx] != null)
            ? sheetTabNames[sheetIdx]
            : ((sheetToCompare && sheetToCompare.options && sheetToCompare.options.length && sheetIdx != null && sheetToCompare.options[sheetIdx])
              ? sheetToCompare.options[sheetIdx].text
              : ((sheetToCompare && sheetToCompare.selectedIndex >= 0 && sheetToCompare.options[sheetToCompare.selectedIndex]) ? sheetToCompare.options[sheetToCompare.selectedIndex].text : (config.sheet_name || 'Sheet')));
          sheetTabCounts[sheetName] = totalIssues;
          if (!sheetTabNames.length && sheetToCompare && sheetToCompare.options) {
            sheetTabNames = Array.from(sheetToCompare.options).filter(function(o) { return o.value !== ''; }).map(function(o) { return o.text; });
          }
          buildSheetTabs(sheetTabNames, parseInt(sheetIndex, 10) || 0);
          cellLevelFilter = 'difference';
          document.querySelectorAll('.cell-tab').forEach(function(t) {
            t.classList.toggle('active', t.getAttribute('data-cell-filter') === 'difference');
            t.setAttribute('aria-selected', t.getAttribute('data-cell-filter') === 'difference');
          });
          document.getElementById('cellLevelSearch').value = '';
          renderCellLevelTable();
          lastCompareData = {
            data: data,
            counts: counts,
            cellRows: cellLevelRows.slice(),
            sheetName: sheetName
          };
          tabSheetValidation.style.display = '';
          tabCellValidation.style.display = '';
          showValidationTab('cell');
          resultsOut.style.display = 'block';
          tabResults.click();
        } catch (e) {
          showResultsError({ error: e.message || 'Request failed', code: 'network' });
        } finally {
          runBtn.disabled = false;
          runBtn.classList.remove('loading');
          if (btnText) btnText.textContent = 'Compare Files';
          if (btnIcon) btnIcon.style.display = '';
        }
      }

      runBtn.addEventListener('click', async () => {
        const f1 = expectedFile.files?.[0];
        const f2 = actualFile.files?.[0];
        hideUploadError();
        if (!f1 || !f2) {
          showUploadError('Please upload both Expected and Actual Excel files.');
          return;
        }
        const compareMode = document.querySelector('input[name="compareMode"]:checked').value;
        runBtn.disabled = true;
        runBtn.classList.add('loading');
        var btnText = runBtn.querySelector('.btn-text');
        var btnIcon = runBtn.querySelector('.fa-play');
        if (btnText) btnText.textContent = 'Comparing…';
        if (btnIcon) btnIcon.style.display = 'none';
        try {
          if (compareMode === 'sheet_count') {
            const formData = new FormData();
            formData.set('expected_file', f1);
            formData.set('actual_file', f2);
            const res = await fetch('/api/compare-sheet-count', { method: 'POST', body: formData });
            const data = await res.json();
            if (!res.ok) {
              showResultsError(data);
              resultsOut.style.display = 'none';
            } else {
              hideResultsError();
              setResultsDateTime();
              applyExportVisibility();
              configText.textContent = 'Sheet count comparison';
              var expectedName = data.expected_filename || 'Expected file';
              var actualName = data.actual_filename || 'Actual file';
              document.getElementById('scExpectedLabel').textContent = expectedName;
              document.getElementById('scActualLabel').textContent = actualName;
              scExpected.textContent = data.expected_sheets;
              scActual.textContent = data.actual_sheets;
              const diff = data.expected_sheets - data.actual_sheets;
              scDifference.textContent = (diff > 0 ? '+' : '') + diff;
              scDifference.parentElement.classList.toggle('match', diff === 0);
              var exp = data.sheet_names_expected || [];
              var act = data.sheet_names_actual || [];
              var setAct = new Set(act);
              var setExp = new Set(exp);
              var matched = exp.filter(function(n) { return setAct.has(n); });
              var missing = exp.filter(function(n) { return !setAct.has(n); });
              var additional = act.filter(function(n) { return !setExp.has(n); });
              lastSheetCountData = {
                expected_sheets: data.expected_sheets,
                actual_sheets: data.actual_sheets,
                expected_filename: data.expected_filename || 'Expected file',
                actual_filename: data.actual_filename || 'Actual file',
                sheet_names_expected: exp,
                sheet_names_actual: act,
                matched: matched,
                missing: missing,
                additional: additional,
                timestamp: { date: resultsDate.textContent || new Date().toLocaleDateString(), time: resultsTime.textContent || new Date().toLocaleTimeString() }
              };
              function sheetLabel(c) { return c + ' sheet' + (c !== 1 ? 's' : ''); }
              document.getElementById('presenceMatchedCount').textContent = sheetLabel(matched.length);
              document.getElementById('presenceMissingCount').textContent = sheetLabel(missing.length);
              document.getElementById('presenceAdditionalCount').textContent = sheetLabel(additional.length);
              document.getElementById('presenceMatchedDesc').textContent = matched.length + ' sheet' + (matched.length !== 1 ? 's' : '') + ' found in both files.';
              document.getElementById('presenceMatchedTags').innerHTML = matched.map(function(n) { return '<span class="presence-tag">' + escapeHtml(n) + '</span>'; }).join('') || '<span class="presence-desc">None</span>';
              document.getElementById('presenceMissingTags').innerHTML = missing.map(function(n) { return '<span class="presence-tag">' + escapeHtml(n) + '</span>'; }).join('') || '<span class="presence-desc">None</span>';
              document.getElementById('presenceAdditionalTags').innerHTML = additional.map(function(n) { return '<span class="presence-tag">' + escapeHtml(n) + '</span>'; }).join('') || '<span class="presence-desc">None</span>';
              specificResultContent.style.display = 'none';
              tabSheetValidation.style.display = '';
              tabCellValidation.style.display = 'none';
              showValidationTab('sheet');
              resultsOut.style.display = 'block';
              tabResults.click();
            }
          } else {
            const sheetIdx = (sheetToCompare && sheetToCompare.value !== '') ? parseInt(sheetToCompare.value, 10) : 0;
            await runCompareForSheet(sheetIdx);
          }
        } catch (e) {
          showResultsError({ error: e.message || 'Request failed', code: 'network' });
        } finally {
          runBtn.disabled = false;
          runBtn.classList.remove('loading');
          if (btnText) btnText.textContent = 'Compare Files';
          if (btnIcon) btnIcon.style.display = '';
        }
      });
    })();
  </script>
</body>
</html>
